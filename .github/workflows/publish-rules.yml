name: Publish Agent Rules (Latest)

on:
  push:
    branches:
      - main # –ò–ª–∏ main, —É–∫–∞–∂–∏ —Å–≤–æ—é –æ—Å–Ω–æ–≤–Ω—É—é –≤–µ—Ç–∫—É
    paths:
      - '.agent/rules/**'
      - 'README.md'
      - '.github/workflows/publish-rules.yml'

permissions:
  contents: write

jobs:
  publish-latest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Pack Rules
        run: |
          # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ —Å–æ –≤—Å–µ–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É, —á—Ç–æ–±—ã –≤ –∞—Ä—Ö–∏–≤–µ –Ω–µ –±—ã–ª–æ –ª–∏—à–Ω–∏—Ö –ø—É—Ç–µ–π parents
          cd .agent/rules
          zip -r ../../agent_rules.zip .
          cd ../..
          
          echo "‚úÖ Rules packed into agent_rules.zip"
          ls -lh agent_rules.zip

      - name: üîÑ Update 'latest' Tag
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ç–µ–≥ latest –ª–æ–∫–∞–ª—å–Ω–æ –∏ —É–¥–∞–ª–µ–Ω–Ω–æ (–µ—Å–ª–∏ –µ—Å—Ç—å)
          git tag -d latest || true
          git push origin :refs/tags/latest || true
          
          # –°–æ–∑–¥–∞–µ–º —Ç–µ–≥ –∑–∞–Ω–æ–≤–æ –Ω–∞ —Ç–µ–∫—É—â–µ–º –∫–æ–º–º–∏—Ç–µ
          git tag latest
          git push origin latest

      - name: üöÄ Publish Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # –°–æ–∑–¥–∞–µ–º (–∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º) —Ä–µ–ª–∏–∑ —Å –ø–æ–º–µ—Ç–∫–æ–π prerelease=false, make-latest=true
          gh release create latest \
            --title "Latest Agent Rules" \
            --notes "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –æ—Ç $(date -u)" \
            --prerelease=false \
            --latest=true \
            || true

          # –ó–∞–≥—Ä—É–∂–∞–µ–º (–ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º) –∞—Ä—Ö–∏–≤
          gh release upload latest agent_rules.zip --clobber
