name: Publish Agent Rules (Latest)

on:
  push:
    branches:
      - main # –¢–≤–æ—è –æ—Å–Ω–æ–≤–Ω–∞—è –≤–µ—Ç–∫–∞
    paths:
      - '.agent/rules/**'
      - 'README.md'
      - '.github/workflows/publish-rules.yml'

permissions:
  contents: write

jobs:
  publish-latest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Pack Rules with Full Path
        run: |
          # –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º –ø–∞–ø–∫—É .agent/rules —Ü–µ–ª–∏–∫–æ–º, —Å–æ—Ö—Ä–∞–Ω—è—è —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—É—Ç–µ–π.
          # –ü—Ä–∏ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–µ –∞—Ä—Ö–∏–≤–∞ –≤ –∫–æ—Ä–µ–Ω—å –¥—Ä—É–≥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞, –ø–∞–ø–∫–∏ .agent/rules —Å–æ–∑–¥–∞–¥—É—Ç—Å—è —Å–∞–º–∏.
          zip -r agent_rules.zip .agent/rules
          
          echo "‚úÖ Rules packed into agent_rules.zip (structure preserved)"
          unzip -l agent_rules.zip # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–ª—è –ª–æ–≥–æ–≤

      - name: üîÑ Update 'latest' Tag
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          # –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º —Ç–µ–≥ latest
          git tag -d latest || true
          git push origin :refs/tags/latest || true
          git tag latest
          git push origin latest

      - name: üöÄ Publish Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # –°–æ–∑–¥–∞–µ–º —Ä–µ–ª–∏–∑ latest (–µ—Å–ª–∏ –Ω–µ—Ç) –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª —Å –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å—é (--clobber)
          gh release create latest \
            --title "Latest Agent Rules" \
            --notes "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª: $(date -u)" \
            --prerelease=false \
            --latest=true \
            || true

          gh release upload latest agent_rules.zip --clobber
